<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/"/>
    <meta name="htmx-config" content='{"refreshOnHistoryMiss":"true"}'/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glide@(string.IsNullOrEmpty(Title) ? "" : $" - {Title}")</title>
    <link rel="stylesheet" href="@Assets["css/styles.css"]"/>
    <script src="https://unpkg.com/htmx.org@2.0.8"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
        });

        // Also highlight after HTMX swaps - use afterSettle for better timing
        document.addEventListener('htmx:afterSettle', function (evt) {
            // Find all code blocks in the swapped content
            const target = evt.detail.target;
            const codeBlocks = target.querySelectorAll('pre code');

            codeBlocks.forEach((el) => {
                // Remove existing highlight classes to force re-highlighting
                el.className = el.className.replace(/hljs[^\s]*/g, '').trim();
                hljs.highlightElement(el);
            });
        });

        // Date format validation and preview
        function validateDateFormat(event) {
            const input = document.getElementById('date-format-input');
            const errorDiv = document.getElementById('format-error');
            const format = input.value.trim();

            if (!format) {
                errorDiv.textContent = 'Date format is required';
                errorDiv.style.display = 'block';
                event.preventDefault();
                return false;
            }

            // Test the format with a sample date
            try {
                const testDate = new Date(2024, 11, 31); // December 31, 2024
                // This is a basic validation - server will do the real validation
                // Just check for some common patterns
                if (!/[yMdHhmsf]/.test(format)) {
                    throw new Error('Invalid format');
                }
                errorDiv.style.display = 'none';
                return true;
            } catch (e) {
                errorDiv.textContent = 'Invalid date format. Use .NET format strings (e.g., yyyy-MM-dd, MM/dd/yyyy)';
                errorDiv.style.display = 'block';
                event.preventDefault();
                return false;
            }
        }

        function previewDateFormat(format) {
            const previewDiv = document.getElementById('date-preview');
            if (!format) {
                previewDiv.textContent = 'Preview: ';
                return;
            }

            // Send format to server for preview
            fetch('/settings/preview-date-format?format=' + encodeURIComponent(format))
                .then(response => response.text())
                .then(text => {
                    previewDiv.textContent = 'Preview: ' + text;
                })
                .catch(() => {
                    previewDiv.textContent = 'Preview: Invalid format';
                });
        }
    </script>
</head>
<body class="@GetBodyClass()">
@if (ShowNavBar)
{
    <NavBar/>
}
@ChildContent
</body>
</html>

@code
{
    [Parameter] public string Title { get; set; } = "";

    [Parameter] public string BodyClass { get; set; } = "";

    [Parameter] public bool ShowNavBar { get; set; }

    [Parameter] public RenderFragment? ChildContent { get; set; }

    private string GetBodyClass()
    {
        var classes = new List<string>();
        if (!string.IsNullOrEmpty(BodyClass))
        {
            classes.Add(BodyClass);
        }

        if (ShowNavBar)
        {
            classes.Add("has-navbar");
        }

        return string.Join(" ", classes);
    }
}
